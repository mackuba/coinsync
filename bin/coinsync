#!/usr/bin/env ruby

require 'bundler/setup'
require 'coinsync'

require 'fileutils'
require 'yaml'

command = ARGV.shift

case command
when nil
  puts "Usage:"
  puts "  coinsync import - import transaction logs from exchanges"
  puts "  coinsync build - build the input csv from exchange logs"
  puts "  coinsync process - generate the output csv from the input"
  puts "  coinsync run - run the complete process"

when 'balance'
  config = CoinSync::Config.load_from_file('config.yml')
  import = CoinSync::BalanceTask.new(config)
  import.run

when 'import'
  config = CoinSync::Config.load_from_file('config.yml')
  import = CoinSync::ImportTask.new(config)
  import.run(ARGV[1])

when 'build'
  output_name = ARGV.shift

  if output_name.nil?
    puts "Usage: coinsync build <task>"
    exit 1
  end

  output_class = CoinSync::Outputs.registered[output_name.to_sym]

  if output_class.nil?
    puts "Unknown output type: #{output_name}"
    exit 1
  end

  FileUtils.mkdir_p 'build'

  config = CoinSync::Config.load_from_file('config.yml')
  builder = CoinSync::Builder.new(config)
  transactions = builder.build_transaction_list

  output = output_class.new(config, "build/#{output_name}.csv")

  if output.respond_to?(:requires_currency_conversion?) && output.requires_currency_conversion?
    if config.convert_to_currency
      converter = CoinSync::CurrencyConverter.new(config)
      converter.process_transactions(transactions)
    end
  end

  output.process_transactions(transactions)

else
  raise "Unknown command #{command}"

end
