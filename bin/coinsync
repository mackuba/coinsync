#!/usr/bin/env ruby

require 'bundler/setup'
require 'coinsync'

require 'fileutils'
require 'yaml'

command = ARGV[0]

case command
when nil
  puts "Usage:"
  puts "  coinsync import - import transaction logs from exchanges"
  puts "  coinsync build - build the input csv from exchange logs"
  puts "  coinsync process - generate the output csv from the input"
  puts "  coinsync run - run the complete process"

when 'build'
  FileUtils.mkdir_p 'build'

  config = CoinSync::Config.load_from_file('config.yml')
  builder = CoinSync::Builder.new(config)
  builder.build_transaction_list

  formatter = CoinSync::Importers::Default.new(config)

  CSV.open('build/input.csv', 'w', col_sep: config.column_separator) do |csv|
    builder.transactions.each do |tx|
      csv << formatter.save_to_csv(tx)
    end
  end

else
  raise "Unknown command #{command}"

end
